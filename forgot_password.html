<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <img src="logo.jpg" alt="The Daily Grind Logo" class="logo">
            <nav>
                <a href="index.html">Home</a>
                <a href="house_blend.html">House Blend</a>
                <a href="contact.html">Contact Us</a>
                <a href="registration.html">Register</a>
                <a href="sitemap.html">Site Map</a>
                <a href="poll.html">Poll</a>
            </nav>
        </header>
        <main>
            <h1>Forgot Your Password?</h1>
            <p>You can reset your password using your security questions.</p>

            <div class="form-container">
                <form id="forgot-password-form" onsubmit="handleForgotPassword(event)">
                    <div>
                        <label for="fp-username">Login Username:</label>
                        <input type="text" id="fp-username" name="login_username" required>
                    </div>
                    <div id="security-questions" style="display: none;">
                        <div>
                            <label for="security-q1-label" id="security-q1-label"></label>
                            <input type="text" id="security-a1-input" name="security_answer_1" required>
                        </div>
                        <div>
                            <label for="security-q2-label" id="security-q2-label"></label>
                            <input type="text" id="security-a2-input" name="security_answer_2" required>
                        </div>
                        <div>
                            <label for="new-password">New Password:</label>
                            <input type="password" id="new-password" name="new_password" required>
                        </div>
                        <div>
                            <label for="confirm-new-password">Confirm New Password:</label>
                            <input type="password" id="confirm-new-password" name="confirm_new_password" required>
                        </div>
                    </div>
                    <div class="button-container">
                        <button type="submit" id="check-username-button">Check Username</button>
                    </div>
                </form>
                <p id="forgot-password-feedback"></p>
            </div>
        </main>
    </div>

    <footer>
        <p id="current-date"></p>
    </footer>

    <script src="js/scripts.js"></script>
    <script>
        let step = 1;
        document.getElementById('forgot-password-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('fp-username').value;
            const feedback = document.getElementById('forgot-password-feedback');

            if (step === 1) {
                // Fetch security questions
                fetch(`forgot_password_questions.php?login_username=${username}`)
                .then(response => response.json())
                .then(data => {
                    if (data.security_question_1) {
                        document.getElementById('security-q1-label').textContent = data.security_question_1;
                        document.getElementById('security-q2-label').textContent = data.security_question_2;
                        document.getElementById('security-questions').style.display = 'block';
                        document.getElementById('check-username-button').textContent = 'Reset Password';
                        step = 2;
                        feedback.textContent = '';
                    } else {
                        feedback.textContent = 'Username not found.';
                    }
                })
                .catch(() => {
                    feedback.textContent = 'User not found.';
                });
            } else if (step === 2) {
                const newPassword = document.getElementById('new-password').value;
                const confirmNewPassword = document.getElementById('confirm-new-password').value;
                if (newPassword !== confirmNewPassword) {
                    feedback.textContent = 'Passwords do not match.';
                    return;
                }

                const formData = new FormData(e.target);
                fetch('forgot_password_questions.php', {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                })
                .then(response => response.text())
                .then(data => {
                    if (data.includes('SUCCESS')) {
                        // If security questions match, send a new request to update password
                        const updateFormData = new FormData();
                        updateFormData.append('login_username', username);
                        updateFormData.append('new_password', newPassword);

                        fetch('update_password.php', {
                            method: 'POST',
                            body: new URLSearchParams(updateFormData)
                        })
                        .then(updateResponse => updateResponse.text())
                        .then(updateData => {
                            if (updateData.includes('SUCCESS')) {
                                feedback.textContent = 'Password has been successfully reset!';
                                feedback.style.color = 'green';
                                document.getElementById('forgot-password-form').reset();
                                setTimeout(() => window.location.href = 'index.html', 3000);
                            } else {
                                feedback.textContent = 'Failed to update password. Please try again.';
                            }
                        });
                    } else {
                        feedback.textContent = 'Security answers are incorrect.';
                    }
                });
            }
        });
    </script>
</body>
</html>
