<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="style.css">
    <script src="[https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID_SANDBOX](https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID_SANDBOX)"></script>
</head>
<body>
    <div class="container">
        <header>
            <img src="logo.jpg" alt="The Daily Grind Logo" class="logo">
            <nav>
                <a href="index.html">Home</a>
                <a href="about.html">About Us</a>
                <a href="products.html">Shop</a>
                <a href="house_blend.html">House Blend</a>
                <a href="contact.html">Contact Us</a>
                <a href="registration.html">Register</a>
                <a href="sitemap.html">Site Map</a>
                <a href="poll.html">Poll</a>
                <a href="apps.html">Our Apps</a>
                <a href="nutrition.html">Nutrition Info</a>
                <a href="products.xml">Product XML</a>
                <a href="cart.html" class="cart-link">
                    Shopping Cart (<span id="cart-count">0</span>)
                </a>
            </nav>
        </header>
        <main>
            <h1>Your Shopping Cart</h1>
            <div id="cart-items">
                <!-- Cart items will be displayed here -->
            </div>
            <div id="cart-summary">
                <p>Total: $<span id="cart-total">0.00</span></p>
            </div>
            <div id="paypal-button-container" class="paypal-container"></div>
            <div id="message-box" class="message-box" style="display:none;"></div>
        </main>
    </div>

    <footer>
        <p id="current-date"></p>
    </footer>

    <script src="js/scripts.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            displayCart();
            updateCartCount();
        });
        
        function displayCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || {};
            const cartItemsDiv = document.getElementById('cart-items');
            cartItemsDiv.innerHTML = '';
            let total = 0;

            if (Object.keys(cart).length === 0) {
                cartItemsDiv.innerHTML = '<p>Your cart is empty.</p>';
                document.getElementById('paypal-button-container').style.display = 'none';
                document.getElementById('cart-summary').style.display = 'none';
                return;
            }

            Object.values(cart).forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                itemDiv.innerHTML = `
                    <p>${item.name} (x${item.quantity}) - $${item.price.toFixed(2)} each</p>
                    <p>Subtotal: $${itemTotal.toFixed(2)}</p>
                    <button onclick="removeFromCart(${item.id})">Remove</button>
                `;
                cartItemsDiv.appendChild(itemDiv);
            });

            document.getElementById('cart-total').textContent = total.toFixed(2);
            renderPayPalButton(total.toFixed(2));
        }

        function removeFromCart(productId) {
            let cart = JSON.parse(localStorage.getItem('cart')) || {};
            if (cart[productId]) {
                delete cart[productId];
                localStorage.setItem('cart', JSON.stringify(cart));
            }
            displayCart();
            updateCartCount();
        }

        function renderPayPalButton(totalAmount) {
            paypal.Buttons({
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: totalAmount
                            }
                        }]
                    });
                },
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(details) {
                        const messageBox = document.getElementById('message-box');
                        messageBox.style.display = 'block';
                        messageBox.textContent = 'Processing your order...';
                        
                        // Send cart and PayPal details to server
                        const cartData = JSON.parse(localStorage.getItem('cart'));
                        const customerId = localStorage.getItem('daily_grind_user_id') || 0; // Use a placeholder if not logged in

                        fetch('checkout.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                orderID: data.orderID,
                                totalAmount: totalAmount,
                                customerId: customerId,
                                cart: cartData
                            })
                        })
                        .then(response => response.json())
                        .then(serverData => {
                            if (serverData.status === 'success') {
                                localStorage.removeItem('cart');
                                window.location.href = `receipt.html?orderId=${serverData.orderId}`;
                            } else {
                                messageBox.textContent = 'Error during checkout: ' + serverData.message;
                            }
                        })
                        .catch(error => {
                            messageBox.textContent = 'Error during checkout: ' + error;
                        });
                    });
                }
            }).render('#paypal-button-container');
        }
    </script>
</body>
</html>
